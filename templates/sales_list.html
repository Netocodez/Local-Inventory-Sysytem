{% extends "base.html" %}
{% block content %}

<form method="get" class="mb-3">
    <input type="text" name="q" class="form-control" placeholder="Search sales by receipt no or product name..." value="{{ request.args.get('q', '') }}">
</form>

<div class="d-grid gap-2 d-md-flex justify-content-md-start mb-3">
    <a href="{{ url_for('record_sale') }}" class="btn btn-primary me-md-2">Sell New Item</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-dark alert-dismissible fade show flash-message" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead class="table-success">
            <tr>
                <th>Transaction ID</th>
                <th>Customer</th>
                <th>Payment</th>
                <th>User</th>
                <th>Date</th>
                <th>Products</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for transaction_id, sales in grouped_sales.items() %}
            {% if transaction_id is not none and transaction_id in transaction_info %}
                {% set t = transaction_info[transaction_id] %}
                <tr class="table-primary">
                    <td>{{ transaction_id }}</td>
                    <td>{{ t.customer_name or '-' }}</td>
                    <td>{{ t.payment_type or '-' }}</td>
                    <td>{{ t.user.username if t.user else '-' }}</td>
                    <td>{{ t.timestamp.strftime('%Y-%m-%d %H:%M') if t.timestamp else '-' }}</td>
                    <td>
                        <ul class="mb-0">
                            {% for sale in sales %}
                            <li>{{ sale.product_name }} ({{ sale.quantity }}) @ ₦{{ "%.2f"|format(sale.unit_price) }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td>
                        ₦{{ "%.2f"|format(sales | sum(attribute='total_price')) }}
                    </td>
                    <td>
                        <a href="{{ url_for('view_transaction_receipt', transaction_id=transaction_id) }}" class="btn btn-sm btn-primary mb-1">View</a>
                        {% if current_user.is_authenticated and current_user.is_admin() %}
                            <a href="{{ url_for('edit_transaction', transaction_id=transaction_id) }}" class="btn btn-sm btn-warning mb-1">Edit</a>
                            <form action="{{ url_for('delete_transaction', transaction_id=transaction_id) }}" method="post" style="display:inline;" onsubmit="return confirm('Delete entire transaction?');">
                                <button type="submit" class="btn btn-sm btn-danger">Del</button>
                            </form>
                        {% endif %}
                    </td>

                </tr>
            {% endif %}
        {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
