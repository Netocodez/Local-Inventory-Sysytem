{% extends "base.html" %}
{% block content %}
<form method="get" class="mb-3">
    <input type="text" name="q" class="form-control" placeholder="Search sales by receipt no or product name..." value="{{ request.args.get('q', '') }}">
</form>

<a href="{{ url_for('record_sale') }}" class="btn btn-primary mb-3">Sell New Item</a>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-dark alert-dismissible fade show flash-message" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}


<table class="table table-bordered table-hover table-striped table-responsive" id="sales-table">
    <thead class="table-success">
        <tr>
            <th>Sale ID</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Unit Price</th>
            <th>Total Price</th>
            <th>Customer</th>
            <th>Payment Type</th>
            <!--<th>Comments</th>-->
            <th>User</th>
            <th>Date</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for sale in sales %}
        <tr>
            <td>{{ sale.id }}</td>
            <td>{{ sale.product_name }}</td>
            <td>{{ sale.quantity }}</td>
            <td>${{ "%.2f"|format(sale.unit_price) }}</td>
            <td>${{ "%.2f"|format(sale.total_price) }}</td>
            <td>{{ sale.customer_name or '-' }}</td>
            <td>{{ sale.payment_type or '-' }}</td>
            <!--<td>{{ sale.comments or '-' }}</td>-->
            <td>{{ sale.username }}</td>
            <td style="vertical-align: middle; white-space: nowrap;">{{ sale.timestamp }}</td>
            <td style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
                <a href="{{ url_for('view_receipt', sale_id=sale.id) }}" class="btn btn-sm btn-primary">View Receipt</a>
                
                {% if current_user.is_authenticated and current_user.is_admin() %}
                <a href="{{ url_for('edit_sale', sale_id=sale.id) }}" class="btn btn-sm btn-warning">Edit</a>

                <form action="{{ url_for('delete_sale', sale_id=sale.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this sale?');">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                </form>
                {% endif %}
            </td>

        </tr>
        {% else %}
        <tr><td colspan="10">No sales found.</td></tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
